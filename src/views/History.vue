<template>
	<div class="table">
		<el-table
		    :data="tableData"
			:cell-style="tableRowStyle"
			:header-cell-style="tableHeaderColor"
			stripe
			border
		    style="width: 100%"
		    height="450">
		    <el-table-column
		      prop="fileName"
		      label="名称"
		      width="700">
			  <template slot-scope="scope">
			        <el-button @click="displayMessage(scope.row)" type="text">{{scope.row.fileName}}</el-button>
			  </template>
		    </el-table-column>
		    <el-table-column
		      prop="uploadTime"
		      label="上传时间"
			  :formatter="dateFormat"
		      width="155">
		    </el-table-column>
		    <el-table-column
		      prop="status"
		      label="状态"
		      width="120">
		    </el-table-column>
		    <el-table-column
		      prop="city"
		      label="操作"
		      >
			  <template slot="header" slot-scope="scope">
			    <el-input
				  class="input-with-select"
			      v-model="search"
			      size="mini"
				  :clearable= true
				  @clear="clearSeach"
			      placeholder="输入关键字搜索">
				  <el-button slot="prepend" icon="el-icon-search" @click="searchSample(search)"></el-button> 
				</el-input>
			  </template>
			  <template slot-scope="scope">
			          <el-button @click="handleClick(scope.row)" type="text" size="small" :disabled="scope.row.status == 'executed' ? false : true">查看API日志</el-button>
			          <el-button @click="analyzeClick(scope.row)" type="text" size="small" :disabled="scope.row.status == 'executed' ? false : true">开始分析</el-button>
					  <el-button @click="resultClick(scope.row)" type="text" size="small" :disabled="scope.row.predictStatus == '1' ? false : true">查看结果报告</el-button>
					  <el-button @click="deleteClick(scope.row)" type="text" size="small">删除</el-button>
			  </template>
		    </el-table-column>
		  </el-table>
		  <el-pagination
		    background
		    layout="prev, pager, next"
			:page-size="pageSize"
			@current-change="page"
		    :total="total">
		  </el-pagination>
	</div>
</template>

<script>
	import moment from 'moment'
	export default{
		inject:['reload'],
		data(){
			return{
				errorFormat:false,
				oldList:[],
				newList:[],
				search:"",
				totalSampleList:[],
				fullscreenLoading: false,
				pageItem:6,
				pageSize:6,
				total:5,
				currentPage:1,
				tableData:[
				],
				apiMessage:{
					calls:[
						{
						    "return_value": null,
						    "stacktrace": null,
						    "nt_status": null,
						    "flags": null,
						    "arguments": null,
						    "api": null,
						    "last_error": null,
						    "time": null,
						    "category": null,
						    "tid": null,
						    "status": null
						}
					],
					apiStatus:{}
				}
			}
		},
		methods: {
			searchSample(search){
				console.log(search)
				this.oldlist=this.totalSampleList;
				this.newList=[];
				for(let i=0;i<this.oldlist.length;i++){
					if(this.oldlist[i].fileName.indexOf(search)>=0){
						this.newList.push(this.oldlist[i]);
					}
				}
				//判断找没找到
				if(this.newList.length==0){
					this.$confirm('没有找到你要的结果', '提示', {
					          confirmButtonText: '确定',
					          type: 'warning'
					        }).then(() => {
								this.search=""
                      })
					// alert("没有找到你要的结果")
					
				}else{
					this.tableData=this.newList;
					
				}
			},
			clearSeach(){
				// console.log("清空输入框")
				this.tableData=this.oldList;
				this.newList=[];
				this.reload();
			},
			page(current){
				const _this = this
				this.currentPage = current;
				//console.log(this.currentPage)
				axios.post('http://localhost:8081/malware/getSampleList',{
									userId:localStorage.getItem("userId"),
									pageSize:_this.pageSize,
									pageIndex:current
						}).then(function(resp){
					if(_this.newList.length==0){
						_this.tableData = resp.data.data.sampleList
						_this.totalSampleList = resp.data.data.totalSampleList
					}
				    _this.total = (resp.data.data.totalPage)*(_this.pageSize)
					if(resp.data.data.sampleList!=null){
						_this.pageItem = resp.data.data.sampleList.length
					}
					
				})
			},
			dateFormat(row,column){
				var date = row[column.property];
				return moment(date).format("YYYY-MM-DD HH:mm:ss")
			},
			handleClick(row){
				const _this = this;
				//console.log(row)
				//查看API日志,先请求好数据再发过去
				//首先得获取报告先
				 const loading = this.$loading({
				          lock: true,
				          text: 'Loading',
				          spinner: 'el-icon-loading',
				          background: 'rgba(0, 0, 0, 0.7)'
				        });
						
				axios.post('http://localhost:8081/malware/getReport',{
									userId:row.userId,
									sampleId:row.sampleId,
									status:row.status
						}).then(function(resp){
				    console.log(resp)
					//然后才调用这个接口
					if(resp.data.data!=null){
						axios.post('http://localhost:8081/malware/getSampleAPIFile',{
											userId:row.userId,
											sampleId:row.sampleId,
											status:row.status
								}).then(function(resp){
						    console.log(resp)
							if(resp.data.successful){
								loading.close();
								//把数据传给显示页面
								//localStorage.setItem("apiMessage",resp.data.data);
								_this.$router.push({
									path:"/message",
									name:"message",
									params:{apiMessage:resp.data.data,sampleMessage:row,apiDisable:false,resultDisable:true,basicActive:false,apiActive:true,resultActive:false}
								})
							}
							if(!resp.data.successful){
								loading.close();
								//上传的格式不正确
								_this.errorFormat=true
								_this.$confirm('你上传的API文件格式不正确！请重新上传正确的文件', '提示', {
								          confirmButtonText: '确定',
								          cancelButtonText: '取消',
								          type: 'warning'
								})
							}
							
						}).catch(function(err){
							console.log(err)
							loading.close();
						});
					}
					else{
						loading.close();
						//没有api
						_this.$confirm('该样本没有进行api调用!', '提示', {
						          confirmButtonText: '确定',
						          cancelButtonText: '取消',
						          type: 'warning'
						        }).then(() => {
						         
						        })
						// alert("该样本没有进行api调用!")
					}
					
				}).catch(function(err){
					console.log(err)
					loading.close();
					_this.$message.error('查询失败');
				});
				
				
			},
			deleteClick(row){
				const _this = this;
				this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				          type: 'warning'
				        }).then(() => {
							//调用删除接口
							axios.post('http://localhost:8081/malware/deleteSample',{
												userId:row.userId,
												sampleId:row.sampleId
									}).then(function(resp){
										console.log(_this.tableData);
										_this.pageItem--;
										if(_this.pageItem==0){
											if(_this.currentPage>1){
												_this.currentPage--
												_this.pageItem=_this.pageSize
											}
											if(_this.currentPage==1){
												_this.reload()
											}
											//_this.reload()
										}
										_this.$message({
										  type: 'success',
										  message: '删除成功!'
										});
										//console.log(_this.pageItem)
							}).catch(function(err){
								console.log(err)
								
								_this.$message.error('删除失败');
							});

				        }).catch(() => {
				          this.$message({
				            type: 'info',
				            message: '已取消删除'
				          });          
				        });
			},
			analyzeClick(row){
				const _this = this
				//点击开始分析调用分析接口
				const loading = this.$loading({
				         lock: true,
				         text: 'analyzing',
				         spinner: 'el-icon-loading',
				         background: 'rgba(0, 0, 0, 0.7)'
				       });
			    if(this.errorFormat){
					//格式不正确无法分析
					loading.close();
					_this.$confirm('你上传的API文件格式不正确！无法进行分析', '提示', {
					          confirmButtonText: '确定',
					          cancelButtonText: '取消',
					          type: 'warning'
					})
				}
				else{
					axios.post('http://localhost:8081/malware/getReport',{
										userId:row.userId,
										sampleId:row.sampleId,
										status:row.status
							}).then(function(resp){
					    //console.log(resp)
						//然后才调用这个接口
						if(resp.data.data!=null){
							axios.post('http://localhost:8081/malware/familyPredict',{
												userId:row.userId,
												sampleId:row.sampleId,
												status:row.status
									}).then(function(resp){
							    console.log(resp)
								loading.close();
								
								_this.$message({
								          message: '分析完成！',
								          type: 'success'
								        });
							}).catch(function(err){
								console.log(err)
								_this.$message.error('分析失败');
							});
						}
						else{
							//没有api
							loading.close();
							// alert("该样本没有进行api调用无法进行分析！")
							_this.$confirm('该样本没有进行api调用无法进行分析！', '提示', {
							          confirmButtonText: '确定',
							          cancelButtonText: '取消',
							          type: 'warning'
							        }).then(() => {
							         
							        })
						}
						
					}).catch(function(err){
						console.log(err)
						_this.$message.error('分析失败');
					});
				}
				
			},
			resultClick(row){
				const _this = this
				console.log("查看报告")
				axios.post('http://localhost:8081/malware/getSampleAPIFile',{
									userId:row.userId,
									sampleId:row.sampleId,
									status:row.status
						}).then(function(resp){
				    console.log(resp)
					//把数据传给显示页面
					//localStorage.setItem("apiMessage",resp.data.data);
					_this.$router.push({
						path:"/message",
						name:"message",
						params:{apiMessage:resp.data.data,sampleMessage:row,apiDisable:false,resultDisable:false,basicActive:true,apiActive:false,resultActive:false}
					})
				}).catch(function(err){
					_this.$message.error('失败');
				});
			},
			displayMessage(row){
				const _this = this
				//显示样本的基本信息
				//console.log(row)
				//这里做页面跳转
				//localStorage.setItem("sampleMessage",row);
				this.$router.push({
					path:"/message",
					name:"message",
					params:{sampleMessage:row,apiMessage:_this.apiMessage,apiDisable:true,resultDisable:true,basicActive:true,apiActive:false,resultActive:false}
				})
			},
			 // 修改table tr行的背景色
			    tableRowStyle(row,column,rowIndex,columnIndex) {
			      return 'background: #ffffff'
			    },
			    // 修改table header的背景色
			    tableHeaderColor({ row, column, rowIndex, columnIndex }) {
			      if (rowIndex === 0) {
			        return 'background-color: transparent;color: #000000;font-weight: 500;'
			      }
			    }
		},
		created() {
		    const _this = this
		    axios.post('http://localhost:8081/malware/getSampleList',{
								userId:localStorage.getItem("userId"),
								pageSize:_this.pageSize,
								pageIndex:1
					}).then(function(resp){
		        console.log(resp)
				if(resp.data.data.length==0){
					//_this.tableData=null;
					alert("还没有上传过记录")
					_this.$confirm('还没有上传过记录', '提示', {
					          confirmButtonText: '确定',
					          cancelButtonText: '取消',
					          type: 'warning'
					        }).then(() => {
					         
					        })
				}else{
					 _this.tableData = resp.data.data.sampleList
					 _this.totalSampleList = resp.data.data.totalSampleList
					 _this.pageItem=resp.data.data.sampleList.length
					 _this.total = (resp.data.data.totalPage)*(_this.pageSize)
					 var timer = window.setInterval(()=>{
					 	setTimeout(function(){
					 		//console.log("调用一次")
					 		//console.log(_this.tableData)
					 		
					 		axios.post('http://localhost:8081/malware/queryStatus',{
					 							userId:localStorage.getItem("userId"),
					 							sampleList:_this.tableData
					 				}).then(function(resp){
					 		    //console.log(resp)
					 			if(_this.pageItem>0){
					 				_this.page(_this.currentPage);
					 			}
					 		});
					 		//_this.reload()
					 	},0)
					 },3000)
					 localStorage.setItem("timer",timer)
				}
		       
		    }).catch(function(err){
				console.log(err)
				_this.$router.go(0)
			});
			
		}
	}
</script>

<style>
	.el-table--enable-row-hover .el-table__body tr:hover>td{
	background-color: #C1CDCD !important;
	}
	.el-table, .el-table__expanded-cell {
	    background-color: transparent;
	}
	.el-table--border, .el-table--group {
	    border: transparent;
	}
</style>
