<template>
	<div class="table">
		<el-table
		    :data="tableData"
			stripe
			border
		    style="width: 100%"
		    height="450">
		    <el-table-column
		      prop="fileName"
		      label="名称"
		      width="650">
			  <template slot-scope="scope">
			        <el-button @click="displayMessage(scope.row)" type="text">{{scope.row.fileName}}</el-button>
			  </template>
		    </el-table-column>
		    <el-table-column
		      prop="uploadTime"
		      label="上传时间"
			  :formatter="dateFormat"
		      width="155">
		    </el-table-column>
		    <el-table-column
		      prop="status"
		      label="状态"
		      width="120">
		    </el-table-column>
		    <el-table-column
		      prop="city"
		      label="操作"
		      width="500">
			  <template slot-scope="scope">
			          <el-button @click="handleClick(scope.row)" type="text" size="small" :disabled="scope.row.status == 'executed' ? false : true">查看API日志</el-button>
			          <el-button @click="analyzeClick(scope.row)" type="text" size="small" :disabled="scope.row.status == 'executed' ? false : true">开始分析</el-button>
					  <el-button @click="resultClick(scope.row)" type="text" size="small" :disabled="scope.row.predictStatus == '1' ? false : true">查看结果报告</el-button>
					  <el-button @click="deleteClick(scope.row)" type="text" size="small">删除</el-button>
			  </template>
		    </el-table-column>
		  </el-table>
		  <el-pagination
		    background
		    layout="prev, pager, next"
			:page-size="pageSize"
			@current-change="page"
		    :total="total">
		  </el-pagination>
	</div>
</template>

<script>
	import moment from 'moment'
	export default{
		inject:['reload'],
		data(){
			return{
				pageItem:5,
				pageSize:5,
				total:5,
				currentPage:1,
				tableData:[
				]
			}
		},
		methods: {
			page(current){
				const _this = this
				this.currentPage = current;
				//console.log(this.currentPage)
				axios.post('http://localhost:8081/malware/getSampleList',{
									userId:localStorage.getItem("userId"),
									pageSize:_this.pageSize,
									pageIndex:current
						}).then(function(resp){
				    //console.log(resp)
				    _this.tableData = resp.data.data.sampleList
				    _this.total = (resp.data.data.totalPage)*(_this.pageSize)
					if(resp.data.data.sampleList!=null){
						_this.pageItem = resp.data.data.sampleList.length
					}
					
				})
			},
			dateFormat(row,column){
				var date = row[column.property];
				return moment(date).format("YYYY-MM-DD HH:mm:ss")
			},
			handleClick(row){
				const _this = this;
				//console.log(row)
				//查看API日志,先请求好数据再发过去
				//首先得获取报告先
				axios.post('http://localhost:8081/malware/getReport',{
									userId:row.userId,
									sampleId:row.sampleId,
									status:row.status
						}).then(function(resp){
				    //console.log(resp)
					//然后才调用这个接口
					if(resp.data.data!=null){
						axios.post('http://localhost:8081/malware/getSampleAPIFile',{
											userId:row.userId,
											sampleId:row.sampleId,
											status:row.status
								}).then(function(resp){
						    console.log(resp)
							//把数据传给显示页面
							//localStorage.setItem("apiMessage",resp.data.data);
							_this.$router.push({
								path:"/message",
								name:"message",
								params:{apiMessage:resp.data.data,sampleMessage:row}
							})
						}).catch(function(err){
							console.log(err)
						});
					}
					else{
						//没有api
						alert("该样本没有进行api调用!")
					}
					
				}).catch(function(err){
					console.log(err)
				});
				
				
			},
			deleteClick(row){
				const _this = this;
				
				//调用删除接口
				axios.post('http://localhost:8081/malware/deleteSample',{
									userId:row.userId,
									sampleId:row.sampleId
						}).then(function(resp){
							console.log(_this.tableData);
							_this.pageItem--;
							if(_this.pageItem==0){
								if(_this.currentPage>1){
									_this.currentPage--
									_this.pageItem=_this.pageSize
								}
								if(_this.currentPage==1){
									_this.reload()
								}
								//_this.reload()
							}
							alert("删除成功！")
							//console.log(_this.pageItem)
				}).catch(function(err){
					console.log(err)
				});
			},
			analyzeClick(row){
				//点击开始分析调用分析接口
				axios.post('http://localhost:8081/malware/getReport',{
									userId:row.userId,
									sampleId:row.sampleId,
									status:row.status
						}).then(function(resp){
				    //console.log(resp)
					//然后才调用这个接口
					if(resp.data.data!=null){
						axios.post('http://localhost:8081/malware/familyPredict',{
											userId:row.userId,
											sampleId:row.sampleId,
											status:row.status
								}).then(function(resp){
						    console.log(resp)
							alert("分析完成！")
						}).catch(function(err){
							console.log(err)
							
						});
					}
					else{
						//没有api
						alert("该样本没有进行api调用无法进行分析！")
					}
					
				}).catch(function(err){
					console.log(err)
				});
			},
			resultClick(row){
				const _this = this
				console.log("查看报告")
				axios.post('http://localhost:8081/malware/getSampleAPIFile',{
									userId:row.userId,
									sampleId:row.sampleId,
									status:row.status
						}).then(function(resp){
				    console.log(resp)
					//把数据传给显示页面
					//localStorage.setItem("apiMessage",resp.data.data);
					_this.$router.push({
						path:"/message",
						name:"message",
						params:{apiMessage:resp.data.data,sampleMessage:row}
					})
				}).catch(function(err){
					console.log(err)
				});
			},
			displayMessage(row){
				//console.log(row)
				//这里做页面跳转
				//localStorage.setItem("sampleMessage",row);
				this.$router.push({
					path:"/message",
					name:"message",
					params:{sampleMessage:row}
				})
			}
		},
		created() {
		    const _this = this
		    axios.post('http://localhost:8081/malware/getSampleList',{
								userId:localStorage.getItem("userId"),
								pageSize:_this.pageSize,
								pageIndex:1
					}).then(function(resp){
		        console.log(resp)
				if(resp.data.data.length==0){
					//_this.tableData=null;
					alert("还没有上传过记录")
				}else{
					 _this.tableData = resp.data.data.sampleList
					 _this.pageItem=resp.data.data.sampleList.length
					 _this.total = (resp.data.data.totalPage)*(_this.pageSize)
					 window.setInterval(()=>{
					 	setTimeout(function(){
					 		//console.log("调用一次")
					 		//console.log(_this.tableData)
					 		
					 		axios.post('http://localhost:8081/malware/queryStatus',{
					 							userId:localStorage.getItem("userId"),
					 							sampleList:_this.tableData
					 				}).then(function(resp){
					 		    //console.log(resp)
					 			if(_this.pageItem>0){
					 				_this.page(_this.currentPage);
					 			}
					 		});
					 		//_this.reload()
					 	},0)
					 },3000)
				}
		       
		    });
			
		}
	}
</script>

<style>
</style>
