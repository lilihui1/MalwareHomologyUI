<template>
	<div class="login-box">
	       <el-form :rules="forgetPasswordFormRules" ref="forgetPasswordForm" :model="forgetPasswordForm" label-position="right" label-width="auto" show-message>
	           <span class="login-title">欢迎使用恶意性程序同源性分析系统</span>
	           <div style="margin-top: 5px"></div>
	           <el-form-item label="请输入用户名" prop="loginName" class="lableColor">
	               <el-col :span="22">
	                   <el-input type="text" v-model="forgetPasswordForm.loginName"></el-input>
	               </el-col>
	           </el-form-item>
			   <el-form-item label="请输入邮箱" prop="email" class="lableColor">
			       <el-col :span="22">
			           <el-input type="text" v-model="forgetPasswordForm.email"></el-input>
			       </el-col>
			   </el-form-item>
			   
			   <el-form-item label="请输入验证码" prop="validateCode" class="lableColor">
			       <el-col :span="22">
			           <el-input type="text" v-model="forgetPasswordForm.validateCode">
					   <el-button slot="append" :disabled="buttonShow" type="primary" @click="getValidateCode(forgetPasswordForm)">{{showMessage}}</el-button>
					   </el-input>
			       </el-col>
			   </el-form-item>
			   
			   <el-form-item label="请输入新密码" prop="loginPassword" class="lableColor">
			       <el-col :span="22">
			           <el-input type="password" v-model="forgetPasswordForm.loginPassword"></el-input>
			       </el-col>
			   </el-form-item>	           
			   
				<el-form-item label="请确认密码" prop="confirmPassword" class="lableColor">
				    <el-col :span="22">
				        <el-input type="password" v-model="forgetPasswordForm.confirmPassword"></el-input>
				    </el-col>
				</el-form-item>
				
	           <el-form-item>
	               <el-button type="primary" @click="OnSubmit('forgetPasswordForm',forgetPasswordForm)">提交</el-button>
				   <el-button type="primary" @click="cancleClick">取消</el-button>
	           </el-form-item>
	       </el-form>
	   </div>
</template>

<script>
	export default {
	       data() {
					var validatePass = (rule, value, callback) => {
					        if (value === '') {
					          callback(new Error('请再次输入密码'));
					        } else if (value !== this.forgetPasswordForm.loginPassword) {
					          callback(new Error('两次输入密码不一致!'));
					        } else {
					          callback();
					        }
					      };
				    var emailValidate = (rule, value, callback) => {
					        if (value === '') {
					           callback(new Error('请输入邮箱'));
					        }
							else {
								// var verify = /^\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14}/;
								var reg=/^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
								if (!reg.test(value)) {
								    // this.message = '邮箱格式错误, 请重新输入'
									callback(new Error('邮箱格式错误'));
								}
								// else{
								// 	callback();
								// }
					        }
							callback();
					      };
	           return {
				   showMessage:"获取验证码",
				   buttonShow:false,
	               forgetPasswordForm: {
	                   loginName: '',
	                   loginPassword: '',
					   confirmPassword:'',
					   email:'',
					   validateCode:''
	               },
	               // 表单验证，需要在 el-form-item 元素中增加 prop 属性
	               forgetPasswordFormRules: {
	                   loginName: [
	                       {required: true, message: '账号不可为空', trigger: 'blur'}
	                   ],
	                   loginPassword: [
	                       {required: true, message: '密码不可为空', trigger: 'blur'}
	                   ],
					   email: [
					   	{required: true,validator: emailValidate}
					   ],
					   validateCode: [
					       {required: true, message: '验证码不可为空', trigger: 'blur'}
					   ],
					   confirmPassword: [
					    {validator: validatePass, trigger: 'blur'}
					   ]
	               }
	           }
	       },
	       methods: {
			   cancleClick(){
				   //同时要重置状态
				   axios.post('/resetStatus',{
				   	name:""
				   }).then(function(res){
				   }).catch(function(err){
				   	console.log(err);
				   });
			   	   this.$router.replace("/");
			   },
			   getValidateCode(forgetPasswordForm){
				   const _this = this
				   //获取验证码
				   axios.post('/findPassword',{
				   	name:forgetPasswordForm.loginName,
				   	email:forgetPasswordForm.email
				   }).then(function(res){
				   	if(res.data.successful){
				   		//成功
				   		_this.$message('发送成功，请注意查收');
						_this.showMessage="已发送";
						_this.buttonShow=true
				   	}else{
				   		//失败
				   		_this.$message('发送失败');
				   	}
				   }).catch(function(err){
				   	console.log(err);
				   });
			   },
	           OnSubmit(formName,forgetPasswordForm) {
				   const _this = this;
	               this.$refs[formName].validate((valid) => {
	                   if (valid) {
	                       // 使用 vue-router 路由到指定页面，该方式称之为编程式导航
						   axios.post('/resetPassword',{
						   	name:forgetPasswordForm.loginName,
						   	password:forgetPasswordForm.loginPassword,
						   	email:forgetPasswordForm.email,
							randomCode:forgetPasswordForm.validateCode
						   }).then(function(res){
						   	if(res.data.successful){
								_this.$confirm('重置密码成功，快去登陆吧', '提示', {
								   confirmButtonText: '确定',
								   showCancelButton: false,
								   type: 'warning'
								 }).then(() => {
								   _this.$router.replace("/");
								 }).catch(() => {
								   
								 });
						   	}else{
						   		//失败
						   		_this.$message('重置失败');
						   	}
						   }).catch(function(err){
						   	console.log(err);
						   });
	                   } else {
	                       return false;
	                   }
	               });
	           }
	       }
	   }
</script>

<style scoped>
	.login-box {
	        border: 1px solid #DCDFE6;
	        width: 550px;
	        margin: 180px auto;
	        padding: 35px 35px 15px 35px;
	        border-radius: 5px;
	        -webkit-border-radius: 5px;
	        -moz-border-radius: 5px;
	        box-shadow: 0 0 25px paleturquoise;
	    }
	    .login-title {
	        text-align: center;
	        margin: 0 auto 40px auto;
	        color: #00aaff;
	        font-size: 30px;
	        font-weight: bold;
	    }
		
</style>
