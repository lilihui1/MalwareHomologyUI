<template>
	<div class="edit-box">
		<el-form v-show="messageEdit" :rules="loginFormRules" ref="userMessage" :model="userMessage" label-position="right" label-width="auto" show-message>
		    <span class="MessageTitle">用户资料</span>
		    <div style="margin-top: 5px"></div>
		    <el-form-item label="用户名" prop="name">
		        <el-col :span="22">
		            <el-input type="text" v-model="userMessage.name"></el-input>
		        </el-col>
		    </el-form-item>
		    <el-form-item label="邮箱" prop="email">
		        <el-col :span="22">
		            <el-input type="text" v-model="userMessage.email"></el-input>
		        </el-col>
		    </el-form-item>
			<el-form-item label="账户id" prop="userId">
			    <el-col :span="22">
			        <el-input type="text" readonly v-model="userMessage.userId"></el-input>
			    </el-col>
			</el-form-item>
			<el-form-item label="账户类型" prop="role">
			    <el-col :span="22">
			        <el-input type="text" readonly v-model="userMessage.role"></el-input>
			    </el-col>
			</el-form-item>
		    <el-form-item>
				<el-button @click="back" type="primary">返回</el-button>
		        <el-button type="primary" @click="saveMessage('userMessage',userMessage)">保存信息</el-button>
		        <el-button type="primary" @click="editPassword">修改密码</el-button>
				<el-button type="primary" @click="deleteAccount(userMessage)" :disabled="judge()">删除账户</el-button>
		    </el-form-item>
		</el-form>
		<el-dialog title="修改密码" :visible.sync="dialogFormVisible">
		  <el-form :model="passwordModify" :rules="passwordModifyRules" ref="passwordModify">
		    <el-form-item label="输入原密码" :label-width="formLabelWidth" prop="oldPassword">
		      <el-input v-model="passwordModify.oldPassword" autocomplete="off"></el-input>
		    </el-form-item>
		   <el-form-item label="输入新密码" :label-width="formLabelWidth" prop="newPassword">
		     <el-input v-model="passwordModify.newPassword" autocomplete="off"></el-input>
		   </el-form-item>
		   <el-form-item label="请确认密码" :label-width="formLabelWidth" prop="checkPassword">
		     <el-input v-model="passwordModify.checkPassword" autocomplete="off"></el-input>
		   </el-form-item>
		   <el-form-item>
		       <el-button @click="onCancle">取 消</el-button>
		       <el-button type="primary" @click="modifyPassword('passwordModify',passwordModify)">确 定</el-button>
		   </el-form-item>
		  </el-form>
		</el-dialog>
	</div>
	
</template>

<script>
	export default{
		data(){
			var validatePass = (passwordModifyRules, value, callback) => {
			  if (value === '') {
			    callback(new Error('请输入密码'));
			  } else {
			    if (this.passwordModify.newPassword !== '') {
			      this.$refs.passwordModify.validateField('checkPassword');
			    }
			    callback();
			  }
			};
			var validatePass2 = (passwordModifyRules, value, callback) => {
			  if (value === '') {
			    callback(new Error('请再次输入密码'));
			  } else if (value !== this.passwordModify.newPassword) {
			    callback(new Error('两次输入密码不一致!'));
			  } else {
			    callback();
			  }
			};
			return{
				messageEdit:true,
				dialogFormVisible:false,
				userId:0,
				role:"",
				passwordModify:{
					oldPassword:"",
					newPassword:"",
					checkPassword:""
				},
				dialogFormVisible: false,
				formLabelWidth: '120px',
				userMessage:{
					name:"",
					email:"",
					userId:0,
					role:"",
					status:""
				},
				// 表单验证，需要在 el-form-item 元素中增加 prop 属性
				loginFormRules: {
				    name: [
				        {required: true, message: '账号不可为空', trigger: 'blur'}
				    ]
				},
				passwordModifyRules: {
					newPassword: [
					  { validator: validatePass, trigger: 'blur' }
					],
					checkPassword: [
					  { validator: validatePass2, trigger: 'blur' }
					]
				}
			}
		},
		methods: {
			editPassword(){
				this.messageEdit=false,
				this.dialogFormVisible=true
			},
			onCancle(){
				this.messageEdit=true,
				this.dialogFormVisible=false
			},
			back(){
				//返回
				this.$router.push({
					path:"/accountManage",
					name:"accountManage",
					params:{}
				})
			},
			judge(){
				if(this.role=="admin"){
					return false
				}else{
					return true
				}
			},
			saveMessage(formName,userMessage) {
				const _this = this;
			    // 为表单绑定验证功能
			    this.$refs[formName].validate((valid) => {
			        if (valid) {
						axios.post('/malware/updateUserMessage',{
							 userId: _this.userMessage.userId,
							 email: _this.userMessage.email,
							 name: _this.userMessage.name,
							 password: _this.userMessage.password,
							 role: _this.userMessage.role,
							 status: _this.userMessage.status
						}).then(function(res){
							if(res.data.successful){
								//成功
								_this.$message({
								            type: 'success',
								            message: '保存成功!'
								          });
							}else{
								//失败
								// alert(res.data.errorMessage)
								_this.$message({
								            type: 'info',
								            message: res.data.errorMessage
								          });
							}
							console.log(res);
						}).catch(function(err){
							console.log(err);
						});
			        } else {
						console.log('error submit!!');
			            return false;
			        }
			    });
			},
			modifyPassword(formName,passwordModify){
				const _this = this
				//alert("修改成功")
				this.$refs[formName].validate((valid) => {
				    if (valid) {
						axios.post('/malware/updatePassword',{
							 userId: _this.userMessage.userId,
							 oldPassword: passwordModify.oldPassword,
							 newPassword: passwordModify.newPassword
						}).then(function(res){
							if(res.data.successful){
								//成功
								_this.$refs[formName].resetFields();
								_this.dialogFormVisible=false
								alert("修改成功")
							}else{
								//失败
								alert(res.data.errorMessage)
							}
							console.log(res);
						}).catch(function(err){
							console.log(err);
						});
				    } else {
						console.log('error submit!!');
				        return false;
				    }
				});
				
			},
			deleteAccount(userMessage){
				const _this = this
				this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
				          confirmButtonText: '确定',
				          cancelButtonText: '取消',
				          type: 'warning'
				        }).then(() => {
							axios.post('/malware/deleteUser',{
												userId:userMessage.userId
									}).then(function(resp){
							    //console.log(resp)
								//返回上一页
								_this.$message({
								  type: 'success',
								  message: '删除成功!'
								});
								_this.$router.push({
									path:"/accountManage",
									name:"accountManage",
									params:{}
								})
								
							}).catch(function(err){
								console.log(err);
							});
				          
				        }).catch(() => {
				          _this.$message({
				            type: 'info',
				            message: '已取消删除'
				          });          
				        });
				
			}
		},
		created(){
			const _this = this
			this.userId = this.$route.params.userId;
			axios.post('/malware/getUserMessage',{
								userId:_this.userId
					}).then(function(resp){
			    console.log(resp)
				_this.userMessage = resp.data.data
			}).catch(function(err){
				// alert("失败")
				// _this.$router.push({
				// 	path:"/",
				// 	name:"login",
				// 	params:{}
				// })
				//console.log(err);
			});
			axios.post('/malware/getUserMessage',{
								userId:localStorage.getItem("userId")
					}).then(function(resp){
			    console.log(resp)
				_this.role = resp.data.data.role
			}).catch(function(err){
				console.log(err);
			});
		}
	}
</script>

<style>
	.edit-box {
	        border: 1px solid #DCDFE6;
	        width: 550px;
	        margin: 150px auto;
	        padding: 35px 35px 15px 35px;
	        border-radius: 5px;
	        -webkit-border-radius: 5px;
	        -moz-border-radius: 5px;
	        box-shadow: 0 0 25px paleturquoise;
	    }
	    .MessageTitle {
	        text-align: center;
	        margin: 0 auto 40px auto;
	        color: #00aaff;
	        font-size: 30px;
	        font-weight: bold;
	    }
		.el-dialog, .el-pager li {
		    background: aliceblue;
		}
</style>
