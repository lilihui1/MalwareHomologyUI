<template>
	<div>
		<el-button @click="back" type="primary" icon="el-icon-back"></el-button>
		<el-form :rules="loginFormRules" ref="userMessage" :model="userMessage" label-position="right" label-width="auto" show-message>
		    <span class="login-title">用户资料</span>
		    <div style="margin-top: 5px"></div>
		    <el-form-item label="用户名" prop="name">
		        <el-col :span="22">
		            <el-input type="text" v-model="userMessage.name"></el-input>
		        </el-col>
		    </el-form-item>
		    <el-form-item label="邮箱" prop="email">
		        <el-col :span="22">
		            <el-input type="text" v-model="userMessage.email"></el-input>
		        </el-col>
		    </el-form-item>
			<el-form-item label="账户id" prop="userId">
			    <el-col :span="22">
			        <el-input type="text" :disabled="true" v-model="userMessage.userId"></el-input>
			    </el-col>
			</el-form-item>
			<el-form-item label="账户类型" prop="role">
			    <el-col :span="22">
			        <el-input type="text" :disabled="true" v-model="userMessage.role"></el-input>
			    </el-col>
			</el-form-item>
		    <el-form-item>
		        <el-button type="primary" @click="saveMessage('userMessage',userMessage)">保存信息</el-button>
		        <el-button type="primary" @click="dialogFormVisible = true">修改密码</el-button>
				<el-button type="primary" @click="deleteAccount(userMessage)" :disabled="judge()">删除账户</el-button>
		    </el-form-item>
		</el-form>
		<el-dialog title="修改密码" :visible.sync="dialogFormVisible">
		  <el-form :model="passwordModify" :rules="passwordModifyRules" ref="passwordModify">
		    <el-form-item label="输入原密码" :label-width="formLabelWidth" prop="oldPassword">
		      <el-input v-model="passwordModify.oldPassword" autocomplete="off"></el-input>
		    </el-form-item>
		   <el-form-item label="输入新密码" :label-width="formLabelWidth" prop="newPassword">
		     <el-input v-model="passwordModify.newPassword" autocomplete="off"></el-input>
		   </el-form-item>
		   <el-form-item label="请确认密码" :label-width="formLabelWidth" prop="checkPassword">
		     <el-input v-model="passwordModify.checkPassword" autocomplete="off"></el-input>
		   </el-form-item>
		   <el-form-item>
		       <el-button @click="dialogFormVisible = false">取 消</el-button>
		       <el-button type="primary" @click="modifyPassword('passwordModify',passwordModify)">确 定</el-button>
		   </el-form-item>
		  </el-form>
		</el-dialog>
	</div>
	
</template>

<script>
	export default{
		data(){
			var validatePass = (passwordModifyRules, value, callback) => {
			  if (value === '') {
			    callback(new Error('请输入密码'));
			  } else {
			    if (this.passwordModify.newPassword !== '') {
			      this.$refs.passwordModify.validateField('checkPassword');
			    }
			    callback();
			  }
			};
			var validatePass2 = (passwordModifyRules, value, callback) => {
			  if (value === '') {
			    callback(new Error('请再次输入密码'));
			  } else if (value !== this.passwordModify.newPassword) {
			    callback(new Error('两次输入密码不一致!'));
			  } else {
			    callback();
			  }
			};
			return{
				userId:0,
				role:"",
				passwordModify:{
					oldPassword:"",
					newPassword:"",
					checkPassword:""
				},
				dialogFormVisible: false,
				formLabelWidth: '120px',
				userMessage:{
					name:"",
					email:"",
					userId:0,
					role:"",
					status:""
				},
				// 表单验证，需要在 el-form-item 元素中增加 prop 属性
				loginFormRules: {
				    name: [
				        {required: true, message: '账号不可为空', trigger: 'blur'}
				    ]
				},
				passwordModifyRules: {
					newPassword: [
					  { validator: validatePass, trigger: 'blur' }
					],
					checkPassword: [
					  { validator: validatePass2, trigger: 'blur' }
					]
				}
			}
		},
		methods: {
			back(){
				//返回
				this.$router.push({
					path:"/accountManage",
					name:"accountManage",
					params:{}
				})
			},
			judge(){
				if(this.role=="admin"){
					return false
				}else{
					return true
				}
			},
			saveMessage(formName,userMessage) {
				const _this = this;
			    // 为表单绑定验证功能
			    this.$refs[formName].validate((valid) => {
			        if (valid) {
						axios.post('http://localhost:8081/malware/updateUserMessage',{
							 userId: _this.userMessage.userId,
							 email: _this.userMessage.email,
							 name: _this.userMessage.name,
							 password: _this.userMessage.password,
							 role: _this.userMessage.role,
							 status: _this.userMessage.status
						}).then(function(res){
							if(res.data.successful){
								//成功
								alert("保存成功")
							}else{
								//失败
								alert(res.data.errorMessage)
							}
							console.log(res);
						}).catch(function(err){
							console.log(err);
						});
			        } else {
						console.log('error submit!!');
			            return false;
			        }
			    });
			},
			modifyPassword(formName,passwordModify){
				const _this = this
				//alert("修改成功")
				this.$refs[formName].validate((valid) => {
				    if (valid) {
						axios.post('http://localhost:8081/malware/updatePassword',{
							 userId: _this.userMessage.userId,
							 oldPassword: passwordModify.oldPassword,
							 newPassword: passwordModify.newPassword
						}).then(function(res){
							if(res.data.successful){
								//成功
								_this.$refs[formName].resetFields();
								_this.dialogFormVisible=false
								alert("修改成功")
							}else{
								//失败
								alert(res.data.errorMessage)
							}
							console.log(res);
						}).catch(function(err){
							console.log(err);
						});
				    } else {
						console.log('error submit!!');
				        return false;
				    }
				});
				
			},
			deleteAccount(userMessage){
				const _this = this
				axios.post('http://localhost:8081/malware/deleteUser',{
									userId:userMessage.userId
						}).then(function(resp){
				    //console.log(resp)
					//返回上一页
					alert("删除成功")
					_this.$router.push({
						path:"/accountManage",
						name:"accountManage",
						params:{}
					})
					
				}).catch(function(err){
					console.log(err);
				});
			}
		},
		created(){
			const _this = this
			this.userId = this.$route.params.userId;
			axios.post('http://localhost:8081/malware/getUserMessage',{
								userId:_this.userId
					}).then(function(resp){
			    console.log(resp)
				_this.userMessage = resp.data.data
			}).catch(function(err){
				console.log(err);
			});
			axios.post('http://localhost:8081/malware/getUserMessage',{
								userId:localStorage.getItem("userId")
					}).then(function(resp){
			    console.log(resp)
				_this.role = resp.data.data.role
			}).catch(function(err){
				console.log(err);
			});
		}
	}
</script>

<style scoped>
	.login-box {
	        border: 1px solid #DCDFE6;
	        width: 550px;
	        margin: 180px auto;
	        padding: 35px 35px 15px 35px;
	        border-radius: 5px;
	        -webkit-border-radius: 5px;
	        -moz-border-radius: 5px;
	        box-shadow: 0 0 25px palegreen;
	    }
	    .login-title {
	        text-align: center;
	        margin: 0 auto 40px auto;
	        color: #66CD00;
	        font-size: 30px;
	        font-weight: bold;
	    }
</style>
