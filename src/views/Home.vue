<template>
	<div class="navigation">
		<!-- <div class="path">
			<el-input v-model="formdata.path" placeholder="请输入文件路径"></el-input>
		</div> -->
		
		<div class="upload">
			<el-upload
			  class="upload-demo"
			  ref="upload"
			  :file-list="fileList"
			  drag
			  :data="formdata"
			  :limit="1"
			  :auto-upload="false"
			  action="http://222.201.187.174:8088/malware/tasks/create/submit"
			  :headers="myHeader"
			  :before-upload="beforeUploadFile"
			  :on-progress="processFile"
			  :on-change="changeFile"
			  :on-success="handleSuccess"
			  :on-error="handleError"
			  multiple>
			  <i class="el-icon-upload"></i>
			  <div class="el-upload__text">将文件拖到此处，或<strong class="uploadText">点击上传</strong></div>
			  
			  <!-- <div class="el-upload__tip" slot="tip"></div> -->
			</el-upload>
		</div>
		<div class="uploadButton">
			<el-button style="margin-left: 10px;" size="small" type="primary" @click="submitUpload">上传到服务器</el-button>
			<el-button style="margin-left: 10px;" size="small" type="primary" @click="queryUpload">查看上传记录</el-button>
		</div>
	</div>
</template>

<script>
	var token = "Bearer "+localStorage.getItem("token")
	export default {
		data(){
			return{
				userId:0,
				loading: false,
				limitNum:1,
				fileList:[],
				myHeader: {'Authorization':token},
				formdata:{userId:1,path:""}
			}
		},
		methods: {
			queryUpload(){
				this.$router.replace("/showPage");
			},
			submitUpload(){
				this.$refs.upload.submit();
			},
			handleSuccess(res, file, fileList){
				console.log(res)
				this.loading=false
				if(res.successful){
					
					if(this.loading==false){
						
						// alert("上传成功!")
						this.$message({
						            type: 'success',
						            message: '上传成功!'
						          });
						//刷新当前页面
						this.$router.go(0)
						//this.$router.replace("/showPage");
					}
					
				}
			},
			// 文件上传失败时的钩子
			handleError(err, file, fileList) {
				console.log(res);
				this.$message({
				            type: 'error',
				            message: '上传失败!'
				          });
						  this.loading=false
			    // this.$notify.error({
			    // title: '错误',
			    // message: `文件上传失败`
			    // });
			},
			beforeUploadFile(file){
				//console.log("上传文件之前",file)
				 var FileExt = file.name.replace(/.+\./, "");
					  if (['txt','exe','doc','docx'].indexOf(FileExt.toLowerCase()) === -1){            
					  	this.$message({ 
					  		type: 'warning', 
					  		message: '请上传后缀名为txt、exe、doc、docx的附件' 
						 });
					 	return false;       
					  }
				this.loading=true
				 const loading = this.$loading({
				          lock: true,
				          text: 'Loading',
				          spinner: 'el-icon-loading',
				          background: 'rgba(0, 0, 0, 0.7)'
				        });
						if(!this.loading){
							loading.close();
						}
			},
			changeFile(file, fileList){
				console.log("改变文件",file)
				//console.log(fileList)
			},
			processFile(event, file, fileList){
				console.log("处理文件",file)
				//console.log(event)
			}
		},
		created(){
			 //this.userId = this.$route.params.userId;
			 this.userId=localStorage.getItem("userId");
			 //this.formdata.userId = this.$route.params.userId;
			 this.formdata.userId = localStorage.getItem("userId");
		}
	}
</script>

<style scoped>
	  .navigation{
		  position: relative;
		  margin: auto;
		  width: 400px;
		  height: 400px;
	  }
	  .upload{
		  position: absolute;
		  top: 30%;
		  width: 100%;
		  /* height: 50%; */
	  }
	  .path{
		  position: absolute;
		  top: 10%;
		  width: 100%;
		  /* height: 10%; */
	  }
	  .uploadButton{
		  position: absolute;
		  top: 90%;
		  width: 100%;
		  /* height: 50%; */
	  }
	  .upload-demo{
		 /* background-color: #636365; */
		  
	  }
	  /deep/.el-upload-dragger{
		  background-color: transparent;
	  }
	  .el-upload__text{
		  color: #00ff00;
	  }
	  .uploadText{
		  font-style: normal;
		  color: aqua;
	  }
</style>
