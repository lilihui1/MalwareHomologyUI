<template>
	<div class="showMessage">
		<el-header height="80px">
			<div class="header">
				<div class="backButton">
					<el-button @click="back" type="primary" icon="el-icon-back"></el-button>
				</div>
				<div class="title">
					<h1>样本的信息页面</h1>
				</div>
			</div>
		</el-header>
		<el-container style="height: 800px; border: 1px solid #eee">
		  <el-aside width="200px" style="background-color: rgb(144, 147, 153)">
		    <el-row class="tac">
		      <el-col>
		        <el-menu
		          default-active="defaultActive"
		          class="el-menu-vertical-demo"
		          @open="handleOpen"
		          @close="handleClose"
		          background-color="#545c64"
		          text-color="#fff"
		          active-text-color="#ffd04b">
		          <el-submenu index="1">
		            <template slot="title">
		              <i class="el-icon-info"></i>
		              <span>基本信息</span>
		            </template>
		            <el-menu-item-group>
		            </el-menu-item-group>
		            </el-submenu>
		          </el-submenu>
		          <el-submenu index="2" :disabled="apiDisable">
		            <template slot="title">
		              <i class="el-icon-document"></i>
		              <span>API日志</span>
		            </template>
		            <el-menu-item-group>
		            </el-menu-item-group>
		            </el-submenu>
		          </el-submenu>
				  <el-submenu index="3" :disabled="resultDisable">
				    <template slot="title">
				      <i class="el-icon-menu"></i>
				      <span>结果报告</span>
				    </template>
				     <el-submenu index="3-1">
				       <template slot="title">行为树</template>
				     </el-submenu>
					 <el-submenu index="3-2">
					   <template slot="title">相似度</template>
					 </el-submenu>

				    </el-submenu>
				  </el-submenu>
		        </el-menu>
		      </el-col>
		    </el-row>
		  </el-aside>
		   <el-main>
			  <!-- <el-backtop></el-backtop> -->
		       <div class="main">
				   <el-backtop></el-backtop>
				   <div class="basicMessage" v-show="basicActive">
					  <div> 
						   <el-card class="box-card">
						     <div slot="header" class="clearfix">
						       <span>基本信息</span>
						     </div>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">名称</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{sampleMessage.fileName}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">类型</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{sampleMessage.fileType}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">大小</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{sampleMessage.fileSize}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">MD5</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{sampleMessage.md5}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">任务id</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{(sampleMessage.taskId==null?"无":sampleMessage.taskId)}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">状态</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{sampleMessage.status}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">开始执行时间</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{(sampleMessage.beginExecuteTime==null?"暂无":dateFormat(sampleMessage.beginExecuteTime))}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">结束执行时间</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{(sampleMessage.endExecuteTime==null?"暂无":dateFormat(sampleMessage.endExecuteTime))}}</div></el-col>
							</el-row>
							<el-row>
							  <el-col :span="6"><div class="grid-content bg-purple">上传时间</div></el-col>
							  <el-col :span="12"><div class="grid-content bg-purple">{{dateFormat(sampleMessage.uploadTime)}}</div></el-col>
							</el-row>
						   </el-card>
					   </div>
				   </div>
				   <div class="apiLog" v-show="apiActive" ref="block2">
				   		<h1>api日志</h1>
						 <el-table
						    :data="apiMessage.calls.slice((currentPage-1)*pageSize,currentPage*pageSize)" 
							stripe 
						    border
							height="550"
							style="width: 100%">
							<el-table-column
							  type="index"
							  width="50">
							</el-table-column>
						    <el-table-column
						      prop="time"
						      label="时间"
							  :formatter="dateFormat2"
						      width="180">
						    </el-table-column>
						    <el-table-column
						      prop="api"
						      label="名称"
						      width="250">
						    </el-table-column>
							<el-table-column
							      label="参数"
							      width="180">
							      <template slot-scope="scope">
							        <el-popover trigger="hover" placement="top">
							          <p v-for="(val, key, index) in scope.row.arguments">{{key}}:{{val}}</p>
							          <div slot="reference" class="name-wrapper">
							            <el-tag size="medium">{{scope.row.arguments==null?null:"参数"}}</el-tag>
							          </div>
							        </el-popover>
							      </template>
							    </el-table-column>
							<el-table-column
							  prop="return_value"
							  label="返回值">
							</el-table-column>
						  </el-table>
						  <el-pagination
						    background
						    layout="total, sizes, prev, pager, next, jumper"
						  	:page-size="pageSize"
							:current-page="currentPage"
							:page-sizes="[5, 10, 20, 40]"
							@size-change="handleSizeChange"
						  	@current-change="handleCurrentChange"
						    :total="apiMessage.calls.length">
						  </el-pagination>
				   </div>
				   <div class="result">
				   		<div class="behavior" v-show="behaviorActive" ref="block3">
							<el-card class="box-card">
								<div slot="header" class="clearfixTree">
								  <span>行为树</span>
								</div>
								<div id="wrapper">
									<div id="mynetwork"></div>
									 <div id="loadingBar">
									        <div class="outerBorder">
									            <div id="text">0%</div>
									            <div id="border">
									                <div id="bar"></div>
									            </div>
									        </div>
									    </div>
								</div>
							</el-card>
							
						</div>
						<div class="similar" v-show="similarActive" ref="block4">
							<el-card class="box-card">
								<div slot="header" class="clearfix">
								  <span>相似度</span>
								</div>
								<el-row class="text item">
								  <el-col :span="10"><div class="grid-content bg-purple">家族名称</div></el-col>
								  <el-col :span="6"><div class="grid-content bg-purple">相似程度</div></el-col>
								  <el-col :span="4"><div class="grid-content bg-purple">所属家族</div></el-col>
								</el-row>
								<el-row class="text item">
								  <el-col :span="10"><div class="grid-content bg-purple">全新未知家族</div></el-col>
								  <el-col :span="6"><div class="grid-content bg-purple">0</div></el-col>
								  <el-col :span="4"><div class="grid-content bg-purple" v-show="newFamily()"><i class="el-icon-circle-check"></i></div></el-col>
								</el-row>
							  <div v-for="(val, key, index) in familySimilarity" class="text item">
							   <!-- {{key}}:{{val}} -->
								<el-row>
								  <el-col :span="10"><div class="grid-content bg-purple">{{key}}</div></el-col>
								  <el-col :span="6"><div class="grid-content bg-purple">{{val}}</div></el-col>
								  <el-col :span="4"><div class="grid-content bg-purple" v-show="predict(key)"><i class="el-icon-circle-check"></i></div></el-col>
								</el-row>
							  </div>
							</el-card>

						</div>
						<!-- <div class="predict" v-show="predictActive" ref="block5">
							<h1>预测的家族</h1>
							<el-button type="info">{{predictFamily}}</el-button>
						</div> -->
				   </div>
			   </div>
		   </el-main>
		</el-container>
	</div>
</template>
 <link href="https://almende.github.io/vis/dist/vis-network.min.css" rel="stylesheet" type="text/css"/>

<script>
	import moment from 'moment';
	import { DataSet, Network } from 'vis/index-network';
	export default{
		data(){
			return{
				pageSize:10,
				currentPage:1,
				apiMessage:{
					calls:[
						{
						    "return_value": null,
						    "stacktrace": null,
						    "nt_status": null,
						    "flags": null,
						    "arguments": null,
						    "api": null,
						    "last_error": null,
						    "time": null,
						    "category": null,
						    "tid": null,
						    "status": null
						}
					],
					apiStatus:{}
				},
				sampleMessage:{
					sampleId: 16,
					md5: "4340bf46c8ef5d20a57971a3d5b707ba",
					fileName: "Kafan_Sample_0b1f17fef04eb99a8389ce18d457fbdce44ee07eff67225b67e7d5a86c4c6e84.exe",
					userId: 3,
					fileType: "exe",
					status: "executed",
					taskId: 1654,
					fileSize: "620.5KB",
					uploadTime: "2020-03-30T13:45:37.000+0000",
					beginExecuteTime: null,
					endExecuteTime: null,
					predictStatus: "0",
					apiPath: "E:\\\\save\\\\Kafan_Sample_0b1f17fef04eb99a8389ce18d457fbdce44ee07eff67225b67e7d5a86c4c6e84.doc",
					valid: "1"
				},
				apiDisable:true,
				resultDisable:true,
				apiActive:false,
				basicActive:false,
				resultActive:false,
				behaviorActive:false,
				similarActive:false,
				predictActive:false,
				defaultActive:1,
				familySimilarity:null,
				predictFamily:null,
				predictTree:null
			}
		},
		methods: {
			handleSizeChange: function (size) {
			    this.pageSize = size;
			    console.log(this.pageSize)  //每页下拉显示数据
			},
			newFamily(){
				if(this.predictFamily=="这是新的未知家族"){
					return true
				}
				else{
					return false
				}
			},
			predict(key){
				if(this.predictFamily==key){
					return true
				}
				else{
					return false
				}
			},
			handleCurrentChange(currentPage){
				const _this = this
				//console.log(this.currentPage)
				this.currentPage = currentPage;
				console.log(this.currentPage)
			},
			back(){
				//返回到列表页
				this.$router.push({
					path:"/history",
					name:"history",
					params:{}
				})
			},
			drawNetwork(){
				const _this = this
				
				var container = document.getElementById('mynetwork');
				var data = {
				    nodes: new DataSet(_this.predictTree.TreeJson.nodes),
				    edges: new DataSet(_this.predictTree.TreeJson.edges)
				};
				var options = {
					 nodes: {
					    shape: 'dot',
					    size: 16
					},
					interaction: {hover: true},
					autoResize: true,
					height: '100%',
					width: '100%',
				    configure: {
					enabled:false
				    }
				}
				var network = new Network(container, data, options);
                network.on("stabilizationProgress", function(params) {
                var maxWidth = 496;
                var minWidth = 20;
                var widthFactor = params.iterations/params.total;
                var width = Math.max(minWidth,maxWidth * widthFactor);

                document.getElementById('bar').style.width = width + 'px';
                document.getElementById('text').innerHTML = Math.round(widthFactor*100) + '%';
            });
            network.once("stabilizationIterationsDone", function() {
                document.getElementById('text').innerHTML = '100%';
                document.getElementById('bar').style.width = '496px';
                document.getElementById('loadingBar').style.opacity = 0;
                // really clean the dom element
                setTimeout(function () {document.getElementById('loadingBar').style.display = 'none';}, 500);
            });
			},
			handleOpen(key, keyPath) {
				const _this = this
			    //console.log(key);
				if(key=="1"){
					this.basicActive=true
					// this.goAssignBlock("block1", 100)
				}
				if(key=="2"){
					this.apiActive=true
					// this.goAssignBlock("block2", 100)
				}
				if(key=="3"){
					this.resultActive=true
				}
				if(key=="3-1"){
					this.behaviorActive=true
					
					if(_this.predictTree==null||_this.predictTree==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getTree',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    console.log(resp)
							_this.predictTree = resp.data.data;
							_this.drawNetwork();
						})
						}
						this.goAssignBlock("block3", 100)
				}
				if(key=="3-2"){
					this.similarActive=true
					// console.log(document.getElementsByClassName("similar"));
					document.getElementsByClassName("similar")[0].scrollIntoView(false);
					if(_this.familySimilarity==null||_this.familySimilarity==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getFamilySimilarity',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    //console.log("请求一次")
							_this.familySimilarity = resp.data.data
						})
					}
					if(_this.predictFamily==null||_this.predictFamily==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getPredictFamily',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    console.log(resp)
							_this.predictFamily = resp.data.data
						})
					}
					// this.goAssignBlock("block4", 100)
				}
			},
		
			dateFormat(value){
				if(value!=null){
					var date = value;
					return moment(date).format("YYYY-MM-DD HH:mm:ss")
				}else{
					return null
				}
				
			},
			dateFormat2(row,column){
				//console.log(0|row.time)
				if(row.time!=null){
					row.time = (0|row.time)
					//console.log(row.time)
					// var date = row[column.property];
					// return moment(date).format("YYYY-MM-DD HH:mm")
					var unixTimestamp = new Date(row.time * 1000)
					//var date = unixTimestamp.toLocaleString();
					var minusHour = unixTimestamp.setHours(unixTimestamp.getHours()-8);
					//console.log(moment(minusHour).format("YYYY-MM-DD HH:mm"))
					return moment(minusHour).format("YYYY-MM-DD HH:mm")
				}else{
					return null
				}
				
			},
			dateFormat3(row,column){
				if(row.arguments!=null){
					return JSON.stringify(row.arguments)
				}
			},
			handleClose(key, keyPath) {
			    //console.log(key);
				if(key=="1"){
					this.basicActive=false
				}
				if(key=="2"){
					this.apiActive=false
				}
				if(key=="3"){
					this.resultActive=false
					this.behaviorActive=false
					this.similarActive=false
					this.predictActive=false
				}
				if(key=="3-1"){
					this.behaviorActive=false
				}
				if(key=="3-2"){
					this.similarActive=false
					
					
				}
			
			}
		},
		created(){
			 this.sampleMessage = this.$route.params.sampleMessage;
			 this.apiMessage = this.$route.params.apiMessage;
			 this.apiDisable = this.$route.params.apiDisable;
			 this.resultDisable = this.$route.params.resultDisable;
			 this.basicActive = this.$route.params.basicActive
			 this.apiActive = this.$route.params.apiActive
			 this.resultActive = this.$route.params.resultActive
			 //console.log(this.sampleMessage)
		}
	}
</script>

<style scoped>
	.el-card {
	    min-width: 380px;
	    margin-right: 20px;
		font-size: 17px;
	    transition: all .5s;
		background-color:#c0c4cc
	  }
	  .el-card:hover{
	    margin-top: -5px;
	  }
	   .el-row {
	      margin-bottom: 20px;
	      &:last-child {
	        margin-bottom: 0;
	      }
	    }
	    .el-col {
	      border-radius: 4px;
	    }
		  .row-bg {
		    padding: 10px 0;
		    background-color: #d7d8d9;
		  }
    .mailTable, .mailTable tr, .mailTable tr td{ border:1px solid #a6aa96; width: 150px;}
   .el-aside {
    background-color: #636365;
    color: #3f3f41;
    text-align: center;
    line-height: 200px;
  }
   .el-header{
      background-color: #ffffff;
      color: #333;
      text-align: center;
      line-height: 60px;
    }
  
  .el-main {
    background-color: #E9EEF3;
    color: #333;
	padding: 0px;
  /*  text-align: center; */
    /* line-height: 160px; */
  }
  .text {
      font-size: 17px;
	  text-align:left;
    }
  
    .item {
      padding: 18px 0;
    }
	.clearfix:before,
	  .clearfix:after {
	    display: table;
	    content: "";
	  }
	  .clearfix:after {
	    clear: both
	  }
	  .basicMessage {margin:auto;text-align:left;}
	  .clearfixTree{margin:auto;text-align:left;}
	  .similar{margin:auto;text-align:left;}
    .box-card {
      width: 100%;
    }
  body > .el-container {
    margin-bottom: 40px;
  }
  
  .el-container:nth-child(5) .el-aside,
  .el-container:nth-child(6) .el-aside {
    line-height: 260px;
  }
  
  .el-container:nth-child(7) .el-aside {
    line-height: 320px;
  }
  #mynetwork {
    width: 1240px;
    height: 900px;
    border: 1px solid lightgray;
  }
  .header{
	  /* position: relative; */
	  /* margin: auto; */
  }
  .backButton{
	  float: left;
	  padding: 2px;
  }
  .el-button--primary[data-v-2a26995a]{
      color: #00ffff;
      background-color: #909399;
      border-color: transparent;
  }
  .title{
  }
   #loadingBar {
              position:absolute;
              top:0px;
              left:0px;
              width: 1200px;
              height: 1200px;
              background-color:#E9EEF3;
              -webkit-transition: all 0.5s ease;
              -moz-transition: all 0.5s ease;
              -ms-transition: all 0.5s ease;
              -o-transition: all 0.5s ease;
              transition: all 0.5s ease;
              opacity:1;
          }
          #wrapper {
              position:relative;
              width:900px;
              height:900px;
          }
  
          #text {
              position:absolute;
              top:8px;
              left:530px;
              width:30px;
              height:50px;
              margin:auto auto auto auto;
              font-size:22px;
              color: #000000;
          }
  
  
          div.outerBorder {
              position:relative;
              top:400px;
              width:600px;
              height:44px;
              margin:auto auto auto auto;
              border:8px solid rgba(0,0,0,0.1);
              background: rgb(252,252,252); /* Old browsers */
              background: -moz-linear-gradient(top,  rgba(252,252,252,1) 0%, rgba(237,237,237,1) 100%); /* FF3.6+ */
              background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(252,252,252,1)), color-stop(100%,rgba(237,237,237,1))); /* Chrome,Safari4+ */
              background: -webkit-linear-gradient(top,  rgba(252,252,252,1) 0%,rgba(237,237,237,1) 100%); /* Chrome10+,Safari5.1+ */
              background: -o-linear-gradient(top,  rgba(252,252,252,1) 0%,rgba(237,237,237,1) 100%); /* Opera 11.10+ */
              background: -ms-linear-gradient(top,  rgba(252,252,252,1) 0%,rgba(237,237,237,1) 100%); /* IE10+ */
              background: linear-gradient(to bottom,  rgba(252,252,252,1) 0%,rgba(237,237,237,1) 100%); /* W3C */
              filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#fcfcfc', endColorstr='#ededed',GradientType=0 ); /* IE6-9 */
              border-radius:72px;
              box-shadow: 0px 0px 10px rgba(0,0,0,0.2);
          }
  
          #border {
              position:absolute;
              top:10px;
              left:10px;
              width:500px;
              height:23px;
              margin:auto auto auto auto;
              box-shadow: 0px 0px 4px rgba(0,0,0,0.2);
              border-radius:10px;
          }
  
          #bar {
              position:absolute;
              top:0px;
              left:0px;
              width:20px;
              height:20px;
              margin:auto auto auto auto;
              border-radius:11px;
              border:2px solid rgba(30,30,30,0.05);
              background: rgb(0, 173, 246); /* Old browsers */
              box-shadow: 2px 0px 4px rgba(0,0,0,0.4);
          }
		  .el-header[data-v-2a26995a] {
		      background-color: #909399;
		      color: #333;
		      text-align: center;
		      line-height: 60px;
		  }
		.bodyStyle{
			padding: 0px;
		}
  
</style>
