<template>
	<div class="showMessage">
		<el-button @click="back" type="primary" icon="el-icon-back"></el-button>
		<h1>样本的信息页面</h1>
		<el-container style="height: 800px; border: 1px solid #eee">
		  <el-aside width="200px" style="background-color: rgb(238, 241, 246)">
		    <el-row class="tac">
		      <el-col>
		        <el-menu
		          default-active="defaultActive"
		          class="el-menu-vertical-demo"
		          @open="handleOpen"
		          @close="handleClose"
		          background-color="#545c64"
		          text-color="#fff"
		          active-text-color="#ffd04b">
		          <el-submenu index="1">
		            <template slot="title">
		              <i class="el-icon-location"></i>
		              <span>基本信息</span>
		            </template>
		            <el-menu-item-group>
		            </el-menu-item-group>
		            </el-submenu>
		          </el-submenu>
		          <el-submenu index="2" :disabled="apiDisable">
		            <template slot="title">
		              <i class="el-icon-menu"></i>
		              <span>API日志</span>
		            </template>
		            <el-menu-item-group>
		            </el-menu-item-group>
		            </el-submenu>
		          </el-submenu>
				  <el-submenu index="3" :disabled="resultDisable">
				    <template slot="title">
				      <i class="el-icon-menu"></i>
				      <span>结果报告</span>
				    </template>
				     <el-submenu index="3-1">
				       <template slot="title">行为树</template>
				     </el-submenu>
					 <el-submenu index="3-2">
					   <template slot="title">相似度</template>
					 </el-submenu>
					 <el-submenu index="3-3">
					   <template slot="title">预测的家族</template>
					 </el-submenu>
				    </el-submenu>
				  </el-submenu>
		        </el-menu>
		      </el-col>
		    </el-row>
		  </el-aside>
		   <el-main>
		       <div class="main">
				   <div class="basicMessage" v-show="basicActive">
					  <h3>基本信息</h3>
					  <div style="display:flex"> 
					     <table class="mailTable">
					           <tr><td class="column">名称</td></tr>
					           <tr><td class="column">类型</td></tr>
					           <tr><td class="column">大小</td></tr>
					           <tr><td class="column">MD5</td></tr>
					           <tr><td class="column">任务id</td></tr>
					           <tr><td class="column">状态</td></tr>
					           <tr><td class="column">开始执行时间</td></tr>
					           <tr><td class="column">结束执行时间</td></tr>
					           <tr><td class="column">上传时间</td></tr>
					      </table>
						 <table class="mailTable">
						      <tr><td class="column">{{sampleMessage.fileName}}</td></tr>
						      <tr><td class="column">{{sampleMessage.fileType}}</td></tr>
						      <tr><td class="column">{{sampleMessage.fileSize}}</td></tr>
						      <tr><td class="column">{{sampleMessage.md5}}</td></tr>
							  <tr><td class="column">{{sampleMessage.taskId==null?"无":sampleMessage.taskId}}</td></tr>
							  <tr><td class="column">{{sampleMessage.status}}</td></tr>
						      <tr><td class="column">{{sampleMessage.beginExecuteTime==null?"暂无":dateFormat(sampleMessage.beginExecuteTime)}}</td></tr>
						      <tr><td class="column">{{sampleMessage.endExecuteTime==null?"暂无":dateFormat(sampleMessage.endExecuteTime)}}</td></tr>
						      <tr><td class="column">{{dateFormat(sampleMessage.uploadTime)}}</td></tr>
						   </table>
					   </div>
				   </div>
				   <div class="apiLog" v-show="apiActive">
				   		<h1>api日志</h1>
						 <el-table
						    :data="apiMessage.calls"
							stripe 
						    border
							height="550"
							style="width: 100%">
							<el-table-column
							  type="index"
							  width="50">
							</el-table-column>
						    <el-table-column
						      prop="time"
						      label="时间"
							  :formatter="dateFormat2"
						      width="180">
						    </el-table-column>
						    <el-table-column
						      prop="api"
						      label="名称"
						      width="250">
						    </el-table-column>
							<el-table-column
							      label="参数"
							      width="180">
							      <template slot-scope="scope">
							        <el-popover trigger="hover" placement="top">
							          <p v-for="(val, key, index) in scope.row.arguments">{{key}}:{{val}}</p>
							          <div slot="reference" class="name-wrapper">
							            <el-tag size="medium">{{scope.row.arguments==null?null:"参数"}}</el-tag>
							          </div>
							        </el-popover>
							      </template>
							    </el-table-column>
						 <!-- <el-table-column
						     prop="arguments"
						     label="参数"
						     :formatter="dateFormat3"
						     width="380">
						   </el-table-column> -->
							<el-table-column
							  prop="return_value"
							  label="返回值">
							</el-table-column>
						  </el-table>
				   </div>
				   <div class="result">
				   		<div class="behavior" v-show="behaviorActive">
							<h1>行为树</h1>
							<div id="mynetwork"></div>
						</div>
						<div class="similar" v-show="similarActive">
							<h1>相似度</h1>
							<!-- <p v-for="(val, key, index) in familySimilarity">{{key}}:{{val}}</p> -->
							<el-card class="box-card" display="flex">
							  <div v-for="(val, key, index) in familySimilarity" class="text item">
							    {{key}}:{{val}}
							  </div>
							</el-card>

						</div>
						<div class="predict" v-show="predictActive">
							<h1>预测的家族</h1>
							<el-button type="success">{{predictFamily}}</el-button>
						</div>
				   </div>
			   </div>
		   </el-main>
		</el-container>
	</div>
</template>

<script>
	import moment from 'moment';
	import { DataSet, Network } from 'vis/index-network';
	export default{
		data(){
			return{
				apiMessage:{
					calls:[
						{
						    "return_value": null,
						    "stacktrace": null,
						    "nt_status": null,
						    "flags": null,
						    "arguments": null,
						    "api": null,
						    "last_error": null,
						    "time": null,
						    "category": null,
						    "tid": null,
						    "status": null
						}
					],
					apiStatus:{}
				},
				sampleMessage:{
					sampleId: 16,
					md5: "4340bf46c8ef5d20a57971a3d5b707ba",
					fileName: "Kafan_Sample_0b1f17fef04eb99a8389ce18d457fbdce44ee07eff67225b67e7d5a86c4c6e84.exe",
					userId: 3,
					fileType: "exe",
					status: "executed",
					taskId: 1654,
					fileSize: "620.5KB",
					uploadTime: "2020-03-30T13:45:37.000+0000",
					beginExecuteTime: null,
					endExecuteTime: null,
					predictStatus: "0",
					apiPath: "E:\\\\save\\\\Kafan_Sample_0b1f17fef04eb99a8389ce18d457fbdce44ee07eff67225b67e7d5a86c4c6e84.doc",
					valid: "1"
				},
				apiDisable:true,
				resultDisable:true,
				apiActive:false,
				basicActive:false,
				resultActive:false,
				behaviorActive:false,
				similarActive:false,
				predictActive:false,
				defaultActive:1,
				familySimilarity:null,
				predictFamily:null,
				predictTree:null
			}
		},
		methods: {
			back(){
				//返回到列表页
				this.$router.push({
					path:"/history",
					name:"history",
					params:{}
				})
			},
			drawNetwork(){
				const _this = this
				// create a network
				var container = document.getElementById('mynetwork');
				var data = {
				    nodes: new DataSet(_this.predictTree.TreeJson.nodes),
				    edges: new DataSet(_this.predictTree.TreeJson.edges)
				};
				var options = {
					autoResize: true,
					height: '100%',
					width: '100%',
				    configure: {
						enabled:false
				    }
				}
				var network = new Network(container, data, options);
			},
			handleOpen(key, keyPath) {
				const _this = this
			    //console.log(key);
				if(key=="1"){
					this.basicActive=true
				}
				if(key=="2"){
					this.apiActive=true
				}
				if(key=="3"){
					this.resultActive=true
				}
				if(key=="3-1"){
					this.behaviorActive=true
					if(_this.predictTree==null||_this.predictTree==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getTree',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    console.log(resp)
							_this.predictTree = resp.data.data;
							_this.drawNetwork();
						})
						}
				}
				if(key=="3-2"){
					this.similarActive=true
					if(_this.familySimilarity==null||_this.familySimilarity==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getFamilySimilarity',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    //console.log("请求一次")
							_this.familySimilarity = resp.data.data
						})
					}
				}
				if(key=="3-3"){
					this.predictActive=true
					if(_this.predictFamily==null||_this.predictFamily==undefined){
						//请求接口
						axios.post('http://localhost:8081/malware/getPredictFamily',{
											userId:_this.sampleMessage.userId,
											sampleId:_this.sampleMessage.sampleId,
											predictStatus:_this.sampleMessage.predictStatus
								}).then(function(resp){
						    //console.log("请求一次")
							_this.predictFamily = resp.data.data
						})
					}
				}
			},
		
			dateFormat(value){
				if(value!=null){
					var date = value;
					return moment(date).format("YYYY-MM-DD HH:mm:ss")
				}else{
					return null
				}
				
			},
			dateFormat2(row,column){
				//console.log(row)
				if(row.time!=null){
					var date = row[column.property];
					return moment(date).format("YYYY-MM-DD HH:mm:ss")
				}else{
					return null
				}
				
			},
			dateFormat3(row,column){
				if(row.arguments!=null){
					return JSON.stringify(row.arguments)
				}
			},
			handleClose(key, keyPath) {
			    //console.log(key);
				if(key=="1"){
					this.basicActive=false
				}
				if(key=="2"){
					this.apiActive=false
				}
				if(key=="3"){
					this.resultActive=false
					this.behaviorActive=false
					this.similarActive=false
					this.predictActive=false
				}
				if(key=="3-1"){
					this.behaviorActive=false
				}
				if(key=="3-2"){
					this.similarActive=false
				}
				if(key=="3-3"){
					this.predictActive=false
				}
			}
		},
		created(){
			 this.sampleMessage = this.$route.params.sampleMessage;
			 this.apiMessage = this.$route.params.apiMessage;
			 this.apiDisable = this.$route.params.apiDisable;
			 this.resultDisable = this.$route.params.resultDisable;
			 //console.log(this.sampleMessage)
		}
	}
</script>

<style scoped>
    .mailTable, .mailTable tr, .mailTable tr td{ border:1px solid #a6aa96; width: 150px;}
　　/* .mailTable{ font-size: 12px; color: #71787E; }
　　.mailTable tr td{ border:1px solid #00aa00; width: 150px; height: 35px; line-height: 35px; box-sizing: border-box; padding: 0 10px; } */
　　/* .mailTable tr td.column {width: 150px;border:1px solid #a6aa96;} */
  .el-aside {
    background-color: #D3DCE6;
    color: #333;
    text-align: center;
    line-height: 200px;
  }
  
  .el-main {
    background-color: #E9EEF3;
    color: #333;
  /*  text-align: center; */
    /* line-height: 160px; */
  }
  .text {
      font-size: 14px;
    }
  
    .item {
      padding: 18px 0;
    }
  
    .box-card {
      width: 480px;
	  background-color: bisque;
    }
  body > .el-container {
    margin-bottom: 40px;
  }
  
  .el-container:nth-child(5) .el-aside,
  .el-container:nth-child(6) .el-aside {
    line-height: 260px;
  }
  
  .el-container:nth-child(7) .el-aside {
    line-height: 320px;
  }
  #mynetwork {
              width: 1200px;
              height: 1200px;
              border: 1px solid lightgray;
          }
  
</style>
